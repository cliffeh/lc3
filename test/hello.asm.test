#!/bin/bash
set -euxo pipefail

# tests that the object code and symbol table are generated correctly

# TODO maybe do this with hexdump to give some more information about what went sideways
# which hexdump >& /dev/null || { echo "can't find hexdump; skipping test..."; exit 77; }

# if unset we'll expect our input to reside in the directory alongside our script
DIR=$(dirname "$0")
SRCDIR=${SRCDIR:-$DIR/..}
BUILDDIR=${BUILDDIR:-$DIR/..}

ASM="$SRCDIR/test/hello.asm"
OBJ="$SRCDIR/test/hello.obj"
OBJOUT="$BUILDDIR/test/hello.asm.obj.out"
SYM="$SRCDIR/test/hello.sym"
SYMOUT="$BUILDDIR/test/hello.asm.sym.out"

"$BUILDDIR/lc3as" "$ASM" -o "$OBJOUT" -S "$SYMOUT"
diff "$OBJ" "$OBJOUT" && diff "$SYM" "$SYMOUT"
